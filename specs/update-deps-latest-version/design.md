# Design Document: Update Dependencies to Latest Versions

## Overview

This document outlines the design for updating all project dependencies to their latest compatible versions while ensuring that the codebase continues to pass all clippy lints and tests.

## Current State Analysis

### Current Dependencies

Based on `Cargo.toml` and `Cargo.lock` analysis:

**Production Dependencies:**
- `anyhow` v1.0.100 - Error handling utility (latest patch)
- `aws-config` v1.8.12 - AWS SDK configuration (v1 series)
- `aws-sdk-dynamodb` v1.101.0 - AWS DynamoDB SDK (v1 series)
- `serde` v1.0.228 - Serialization framework (latest patch)
- `serde_yaml` v0.9.34+deprecated - **DEPRECATED** YAML support
- `serde_json` v1.0.148 - JSON support (latest)
- `serde_dynamo` v4.3.0 - DynamoDB serde support (v4 series)
- `thiserror` v2.0.17 - Error derive macros (v2 series)
- `tokio` v1.48.0 (optional) - Async runtime (v1 series)
- `xid` v1.1.1 (optional) - Unique ID generation (v1 series)
- `tracing` v0.1.44 - Logging framework (v0.1 series)

**Dev Dependencies:**
- `serde_json` v1.0.140 (specified) vs v1.0.148 (actual)
- `tokio` v1.48.0 - Async runtime

### Key Findings

1. **Critical Issue**: `serde_yaml` v0.9.34 is **deprecated**
   - The maintainer has archived the repository
   - Recommended migration path: `serde_yaml_ng` v0.10.0 (maintained fork)
   - Alternative: `serde_yml` v0.0.12 (different API)

2. **Version Consistency**: Most dependencies are already at or near latest versions
   - `cargo update --dry-run` shows 0 packages to update
   - Minor version specified in `dev-dependencies` for `serde_json` is outdated (1.0.140 vs 1.0.148)

3. **AWS SDK Compatibility**:
   - Using AWS SDK v1 series (stable)
   - `serde_dynamo` feature flag `aws-sdk-dynamodb+1` must match major version

4. **Feature Gates**:
   - `connector` feature: requires `aws-config` and `xid`
   - `test_utils` feature: requires `tokio`

### Code Dependencies on Updated Crates

**serde_yaml Usage:**
- `src/config.rs` line 16: Error type references `serde_yaml::Error`
- `src/config.rs`: YAML parsing via `serde_yaml::from_reader`

**AWS SDK Usage:**
- `src/config.rs`: AWS SDK type conversions (AttributeDefinition, KeyType, etc.)
- `src/connector.rs`: Client creation, table operations
- `src/error.rs`: AWS SDK error types (SdkError, operation errors)

## Technical Approach

### Migration Strategy

#### 1. Migrate from `serde_yaml` to `serde_yaml_ng`

**Rationale**:
- `serde_yaml_ng` is the official maintained fork
- API-compatible with `serde_yaml` v0.9
- Minimal code changes required
- Version 0.10.0 is stable

**Changes Required**:
- Update `Cargo.toml` dependency: `serde_yaml = "0.9"` → `serde_yaml_ng = "0.10"`
- Update import in `src/config.rs`: `use serde_yaml` (no change needed if using crate rename)
- Update error type in `src/error.rs`: `serde_yaml::Error` → `serde_yaml_ng::Error`
- Use Cargo's rename feature: `serde_yaml_ng = { version = "0.10", package = "serde_yaml_ng" }`

**Alternative Considered**:
- `serde_yml` v0.0.12 was considered but has different API and lower version number (0.0.x suggests unstable)

#### 2. Update Minor/Patch Versions

**Direct Updates** (already latest or patch updates):
- Keep existing version constraints with `^` or `~` semver operators
- Update `dev-dependencies` to match actual resolved versions

**No Breaking Changes Expected**:
- AWS SDK v1 is stable; updates within v1.x are backwards compatible
- `thiserror` v2 is current major version
- All other dependencies are using semantic versioning

#### 3. Update Version Specifications

**Current Patterns**:
- Simple major version: `"1"` (e.g., anyhow, serde, tokio)
- Specific minor: `"0.9"` (serde_yaml), `"2"` (thiserror)
- Specific patch in dev-deps: `"1.0.140"` (serde_json)

**Proposed Pattern**:
- Use caret requirements for flexibility: `"1"` or `"1.0"` for stability
- Remove overly-specific patch versions in dev-dependencies
- Keep feature specifications intact

## Components Affected

### Source Files

1. **src/error.rs** (54 lines)
   - Change: `serde_yaml::Error` → `serde_yaml_ng::Error`
   - Impact: Error type definition
   - Risk: Low - type-only change

2. **src/config.rs** (445 lines)
   - Change: Implicit via Cargo rename (no code change needed)
   - Impact: YAML parsing functionality
   - Risk: Low - API compatible

3. **Cargo.toml**
   - Change: Update dependency versions
   - Impact: Build configuration
   - Risk: Low - semver compatible updates

4. **Cargo.lock**
   - Change: Regenerated by cargo
   - Impact: Locked dependency versions
   - Risk: None - auto-generated

### Test Coverage

**Existing Tests** (tests/connector_integration_test.rs):
- `dev_config_should_create_and_describe_table` - Tests YAML loading
- `prod_config_should_return_empty_map_without_creating` - Tests YAML loading
- `simple_pk_table_should_allow_put` - Tests programmatic config
- `multi_table_config_should_create_all_tables` - Tests YAML multi-table
- `dev_config_should_seed_data` - Tests YAML with seed data

**Coverage**: All YAML parsing paths are tested via fixture files in `fixtures/`

### Fixtures

**YAML Files** (no changes required):
- fixtures/dev.yml
- fixtures/prod.yml
- fixtures/multi_table.yml
- fixtures/info.yml
- fixtures/seed_users.json

**Compatibility**: `serde_yaml_ng` maintains compatibility with YAML format

## Risk Assessment

### Risk Matrix

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| API incompatibility in serde_yaml_ng | Low | High | Use Cargo rename; run full test suite |
| AWS SDK breaking changes within v1 | Very Low | Medium | Review CHANGELOG; integration tests |
| Clippy new lints failing | Low | Low | Address new lints; update allow list |
| Test failures from behavior changes | Low | Medium | Run tests before/after; review failures |
| Build failures from missing features | Very Low | High | Verify feature flags; check compilation |

### Major Risks

1. **serde_yaml → serde_yaml_ng Migration**
   - **Risk**: API differences causing compilation errors
   - **Likelihood**: Low (designed as drop-in replacement)
   - **Impact**: High (core functionality)
   - **Mitigation**: Use Cargo package rename; comprehensive testing

2. **AWS SDK Updates**
   - **Risk**: Subtle behavior changes in table operations
   - **Likelihood**: Very Low (stable v1 API)
   - **Impact**: Medium (integration functionality)
   - **Mitigation**: Integration tests with DynamoDB Local

3. **Clippy Lint Changes**
   - **Risk**: New lints introduced in Rust toolchain updates
   - **Likelihood**: Low
   - **Impact**: Low (CI failures, not runtime)
   - **Mitigation**: Review and address lints; update allow list if needed

### Minor Risks

4. **Dependency Resolution Conflicts**
   - **Risk**: Version conflicts between dependencies
   - **Likelihood**: Very Low
   - **Impact**: Medium (build failure)
   - **Mitigation**: `cargo update` resolves automatically

5. **Documentation Drift**
   - **Risk**: Dependency names in docs become outdated
   - **Likelihood**: Medium
   - **Impact**: Low (documentation only)
   - **Mitigation**: Update README and inline docs

## Success Criteria

1. **Build Success**: `cargo build --all-features` succeeds
2. **Clippy Clean**: `cargo clippy --all-features -- -D warnings` passes
3. **Test Pass**: `cargo test --all-features` passes (requires DynamoDB Local)
4. **Feature Parity**: All features compile and function correctly
5. **Documentation**: Updated references to dependency changes
6. **CI/CD**: GitHub Actions workflow passes

## Dependencies and Constraints

### Prerequisites
- DynamoDB Local running on localhost:8000 (for integration tests)
- Rust toolchain 1.90.0 or later (Rust 2024 edition)
- Internet access for crates.io downloads

### Constraints
- Must maintain backwards compatibility (library is v0.5.0)
- Must not change public API surface
- Must maintain edition 2024 compatibility
- Must preserve all existing features

## Alternative Approaches Considered

### 1. Stick with Deprecated serde_yaml
- **Pros**: No code changes
- **Cons**: Security risk, no future updates, deprecated warning
- **Verdict**: Rejected - technical debt

### 2. Migrate to serde_yml
- **Pros**: Modern crate, active development
- **Cons**: Different API (breaking changes), less mature (0.0.x)
- **Verdict**: Rejected - too risky

### 3. Update Only Security-Critical Dependencies
- **Pros**: Minimal changes
- **Cons**: Leaves deprecated dependency, misses improvements
- **Verdict**: Rejected - incomplete solution

### 4. Major Version Bumps (e.g., AWS SDK v2)
- **Pros**: Latest features
- **Cons**: Breaking changes, significant refactoring
- **Verdict**: Out of scope - not requested

## Implementation Impact

### Estimated Changes
- Files modified: 2 (Cargo.toml, src/error.rs)
- Lines of code changed: ~5
- New dependencies: 1 (serde_yaml_ng)
- Removed dependencies: 1 (serde_yaml)

### Backwards Compatibility
- **Public API**: No changes
- **YAML Format**: No changes (compatible)
- **Feature Flags**: No changes
- **Version**: Patch or minor bump (0.5.1 or 0.6.0)

### Performance Impact
- **Expected**: Negligible
- **Reasoning**: Drop-in replacement with same algorithms

## Rollback Plan

If issues arise:
1. Revert Cargo.toml changes
2. Run `cargo update` to restore Cargo.lock
3. Restore src/error.rs if modified
4. Verify tests pass
5. Document issues for future attempts

## Future Considerations

- Monitor `serde_yaml_ng` for updates
- Consider AWS SDK v2 migration in future (separate effort)
- Evaluate `serde_yml` maturity in 6-12 months
- Keep dependencies updated quarterly
